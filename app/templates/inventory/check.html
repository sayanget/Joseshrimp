{% extends "base.html" %}

{% block title %}<span data-i18n="inventory.check">库存盘点</span> - 销售管理系统{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h2><i class="bi bi-clipboard-check"></i> <span data-i18n="inventory.check">库存盘点</span></h2>
    </div>
</div>

<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i> <span data-i18n="inventory.check_title">库存盘点对账</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> <span data-i18n="inventory.check_instructions">盘点说明</span>
                    </h6>
                    <ul class="mb-0">
                        <li data-i18n="inventory.theoretical_note">理论库存由系统自动计算（所有有效库存变动的总和）</li>
                        <li data-i18n="inventory.actual_input">请输入实际盘点的库存数量</li>
                        <li data-i18n="inventory.auto_calculate_diff">系统将自动计算差异并记录</li>
                    </ul>
                </div>

                <form id="checkForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label" data-i18n="inventory.theoretical">理论库存(KG)</label>
                            <input type="text" class="form-control form-control-lg"
                                value="{{ (stock.current_stock_kg | default(0) | number) }}" readonly>
                            <div class="form-text" data-i18n="sales.auto_calculated">系统自动计算</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><span data-i18n="inventory.actual_stock">实际库存</span>(KG) <span
                                    class="text-danger">*</span></label>
                            <input type="number" id="actualKg" class="form-control form-control-lg" step="0.001"
                                required>
                            <div class="form-text" data-i18n="inventory.actual_input">请输入实际盘点数量</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><span data-i18n="inventory.difference">差异</span>(KG)</label>
                        <input type="text" id="differenceKg" class="form-control form-control-lg" readonly>
                        <div class="form-text" data-i18n="inventory.diff_formula">实际库存 - 理论库存</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" data-i18n="inventory.notes">备注</label>
                        <textarea id="notes" class="form-control" rows="3"
                            data-i18n-placeholder="inventory.notes_placeholder"></textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i> <span data-i18n="inventory.submit_check">提交盘点记录</span>
                        </button>
                        <a href="{{ url_for('inventory.current_stock') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> <span data-i18n="common.cancel">取消</span>
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const theoreticalKg = {{ stock.current_stock_kg | default (0) }};

    // Set placeholder using i18n
    document.addEventListener('DOMContentLoaded', () => {
        const notesField = document.getElementById('notes');
        notesField.placeholder = i18n.t('inventory.notes_placeholder');
    });

    // 计算差异
    document.getElementById('actualKg').addEventListener('input', function () {
        const actualKg = parseFloat(this.value) || 0;
        const difference = actualKg - theoreticalKg;
        document.getElementById('differenceKg').value = utils.formatNumber(difference, 3);

        // 根据差异改变颜色
        const diffInput = document.getElementById('differenceKg');
        if (Math.abs(difference) > 50) {
            diffInput.classList.add('text-danger', 'fw-bold');
        } else if (Math.abs(difference) > 20) {
            diffInput.classList.add('text-warning', 'fw-bold');
        } else {
            diffInput.classList.remove('text-danger', 'text-warning', 'fw-bold');
        }
    });

    // 提交表单
    document.getElementById('checkForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const actualKg = parseFloat(document.getElementById('actualKg').value);
        const notes = document.getElementById('notes').value;

        if (!actualKg && actualKg !== 0) {
            utils.showAlert(i18n.t('inventory.enter_actual'), 'danger');
            return;
        }

        const difference = actualKg - theoreticalKg;

        // 这里应该调用API保存盘点记录
        // 由于后端API还未完全实现，暂时只显示确认
        const confirmMsg = `${i18n.t('inventory.confirm_submit')}\n${i18n.t('inventory.theoretical')}: ${theoreticalKg.toFixed(3)} KG\n${i18n.t('inventory.actual_stock')}: ${actualKg.toFixed(3)} KG\n${i18n.t('inventory.difference')}: ${difference.toFixed(3)} KG`;

        if (confirm(confirmMsg)) {
            utils.showAlert(i18n.t('inventory.check_submitted'), 'success');
            setTimeout(() => {
                window.location.href = '{{ url_for("inventory.current_stock") }}';
            }, 1500);
        }
    });
</script>
{% endblock %}